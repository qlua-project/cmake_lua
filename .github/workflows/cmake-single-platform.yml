name: CMake on a single platform

on:
  push:
    branches: [ "v5.4.1", "v5.3.5" ]
  pull_request:
    branches: [ "v5.4.1", "v5.3.5" ]

env:
  BUILD_TYPE: Release
  c_compiler: cl
  cpp_compiler: cl

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Set reusable strings
      id: strings
      shell: bash
      run: |
        BUILD_DIR_NAME=cmake-build-${{env.BUILD_TYPE}}-${{runner.arch}}; echo "build-output-dir=${{github.workspace}}/${BUILD_DIR_NAME,,}" >> "$GITHUB_OUTPUT"

    - name: Configure CMake
      run: >
        cmake -B "${{steps.strings.outputs.build-output-dir}}" --install-prefix "${{github.workspace}}" -Wdev --warn-uninitialized --log-context -L
        -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}
        -DCMAKE_CXX_COMPILER=${{env.cpp_compiler}}
        -DCMAKE_C_COMPILER=${{env.c_compiler}}
        -S "${{github.workspace}}"

    - name: Build
      run: cmake --build ${{steps.strings.outputs.build-output-dir}} --config ${{env.BUILD_TYPE}}

    - name: Install
      run: cmake --install ${{steps.strings.outputs.build-output-dir}}

    - name: Zip
      shell: powershell
      run: Compress-Archive -Path bin,include,lib,src.lua\README.txt -Destination artifact.zip

    # - name: Test
    #   working-directory: ${{github.workspace}}/build
    #   # Execute tests defined by the CMake configuration.
    #   # See https://cmake.org/cmake/help/latest/manual/ctest.1.html for more detail
    #   run: ctest -C ${{env.BUILD_TYPE}}

